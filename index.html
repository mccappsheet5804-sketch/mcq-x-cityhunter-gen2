<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>「MCQ」x「城市獵人」（第二代）</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css"
        integrity="sha512-2bBQCjcnw658Lho4nlXJcc6WkV/UxpE/sAokbXPxQNGqmNdQrWqtw26Ns9kFF/yG792pKR1Sx8/Y1Lf1XN4GKA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.min.js"
        integrity="sha512-nKXmKvJyiGQy343jatQlzDprflyB5c+tKCzGP3Uq67v+lmzfnZUi/ZT+fc6ITZfSC5HhaBKUIvr/nTLCV+7F+Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="./index.css" />
</head>

<body>

    <div class="auth-card" id="auth-card">
        <h2 class="text-center" id="form-title">Login</h2>
        <form id="auth-form" class="mt-4">
            <div class="form-outline">
                <input type="email" id="email-input" class="form-control" placeholder=" " required
                    value="admin@gmail.com" />
                <label class="form-label" for="email-input">Email address</label>
            </div>
            <div class="form-outline">
                <input type="password" id="password-input" class="form-control" placeholder=" " required
                    value="Pass1234" />
                <label class="form-label" for="password-input">Password</label>
            </div>
            <div class="form-outline" id="confirm-password-container" style="display: none;">
                <input type="password" id="confirm-password-input" class="form-control" placeholder=" " required
                    value="Pass1234" />
                <label class="form-label" for="confirm-password-input">Confirmed Password</label>
            </div>
            <button type="button" id="auth-button" class="btn btn-primary btn-block mb-4">Login</button>
            <div class="text-center mb-3">
                <p><span id="membership-status">Not a member?</span> <a href="#!" id="toggle-button">Register</a></p>
            </div>
            <p class="text-danger text-center" id="auth-message"></p>
        </form>
        <div id="loading-indicator" class="d-flex justify-content-center align-items-center" style="visibility: hidden">
            <div>Loading...</div>
        </div>
    </div>

    <div id="tabs-container" class="container mt-4" style="display: none;">
        <ul class="nav nav-tabs">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab1">角色</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab2">問題</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab3">掃瞄</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab4">地圖</a></li>
        </ul>
        <div class="tab-content mt-2">
            <div id="tab1" class="tab-pane active">Content for 角色 tab.</div>
            <div id="tab2" class="tab-pane">Content for 問題 tab.</div>
            <div id="tab3" class="tab-pane">
                <h4>Scan QR Code</h4>
                <div id="location-group-display" class="my-2">地點群組：</div>
                <select class="form-control" id="location-group-input">
                    <option value="" hidden selected>--- 請選擇 ---</option>
                    <option value="__DEBUG__">__DEBUG__</option>
                    <option value="城門谷公園">城門谷公園</option>
                    <option value="九龍公園">九龍公園</option>
                </select>
                <div id="scanner-qr-code" class="mt-2"></div>
                <p id="scanner-output"></p>
            </div>
            <div id="tab4" class="tab-pane">
                <h4>地圖</h4>
                <div id="location-group-2-display" class="my-2">地點群組：</div>
                <select class="form-control mb-2" id="location-group-2-input">
                    <option value="" hidden selected>--- 請選擇 ---</option>
                    <option value="__DEBUG__">__DEBUG__</option>
                    <option value="城門谷公園">城門谷公園</option>
                    <option value="九龍公園">九龍公園</option>
                </select>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script type="module" defer>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBHkSyXhIlblAgfVnu4D9y0edxXS3-0p50",
            authDomain: "mcq-x-cityhunter-gen2.firebaseapp.com",
            projectId: "mcq-x-cityhunter-gen2",
            storageBucket: "mcq-x-cityhunter-gen2.firebasestorage.app",
            messagingSenderId: "84375603912",
            appId: "1:84375603912:web:e795865e8236efedd973fd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        var isMapInitialized = false;
        $(document).ready(init);

        async function init() {
            let isLogin = true;
            let isScanning = true;

            $('#toggle-button').on('click', toggleForm);
            $('#location-group-input').on('change', handleLocationChange);
            $('#auth-button').on('click', handleAuth);
            $('#location-group-2-input').on('change', async function () {
                document.querySelector('#location-group-2-display').innerText = `地點群組: 「${$(this).val()}」`;
                document.querySelector('#location-group-2-input').style.display = 'none';
                if ($(this).val()) {
                    await initMap();
                }
            });

            $('[href="#tab3"]').on(
                "click",
                () => {
                    document.querySelector('#location-group-display').innerText = '地點群組: ';
                    document.querySelector('#location-group-input').style.display = 'block';
                    document.querySelector('#location-group-input').value = '';
                    isScanning = false;
                }
            );

            $('[href="#tab4"]').on(
                "click",
                async () => {
                    document.querySelector('#location-group-2-display').innerText = '地點群組: ';
                    document.querySelector('#location-group-2-input').style.display = 'block';
                    document.querySelector('#location-group-2-input').value = '';
                }
            );
        }

        function handleLocationChange() {
            const selectedValue = $(this).val();
            $('#location-group-display').text(`地點群組: 「${selectedValue}」`).show();
            $('#location-group-input').hide();
            $('#scanner-qr-code').toggle(!!selectedValue);
        }

        function toggleForm() {
            const isLogin = $('#form-title').text() === 'Login';
            $('#form-title').text(isLogin ? 'Register' : 'Login');
            $('#auth-button').text(isLogin ? 'Register' : 'Sign in');
            $('#toggle-button').text(isLogin ? 'Login' : 'Register');
            $('#membership-status').text(isLogin ? 'Already a member?' : 'Not a member?');
            $('#confirm-password-container').toggle(!isLogin);
            $('#auth-message').text('');
        }

        async function handleAuth() {
            $("#loading-indicator").css('visibility', 'visible');
            $("#auth-form").css('visibility', 'hidden');
            const username = $('#email-input').val();
            const password = $('#password-input').val();
            const passwordConfirm = $('#confirm-password-input').val();

            const isLogin = $('#form-title').text() === 'Login';
            if (isLogin) {
                await authenticate(username, password);
            } else if (password === passwordConfirm) {
                await register(username, password);
            } else {
                $('#auth-message').text('Passwords do not match.');
            }

            $("#loading-indicator").css('visibility', 'hidden');
            $("#auth-form").css('visibility', 'visible');
        }

        async function register(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                $('#auth-message').text('Registration successful! Welcome, ' + userCredential.user.email);
                setTimeout(toggleForm, 200);
            } catch (error) {
                $('#auth-message').text(error.message);
            }
        }

        async function authenticate(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const accessToken = await user.getIdToken();
                sessionStorage.setItem('accessToken', accessToken);

                $('#auth-card').hide();
                $('#tabs-container').show();
                $('#auth-message').text('Login successful! Welcome back, ' + user.email);
                await initializeQRScanner();
            } catch (error) {
                $('#auth-message').text(error.message);
            }
        }

        let qrCodeScanner;

        async function initializeQRScanner() {
            const qrCodeSuccessCallback = async (decodedText, decodedResult) => {
                if (!isScanning) return;
                isScanning = false;

                $('#scanner-output').text(`掃描結果: ${decodedText}`);
                
                const gps = await getGPSInfo();
                const data = {
                    decodedText,
                    gps,
                    locationGroup: $('#location-group-input').val()
                };
                await sendDataToServer(data);

                qrCodeScanner.clear()
                    .then(async () => {
                        $('#scanner-output').text("準備重新掃描...");
                        setTimeout(() => {
                            isScanning = true;
                            $('#scanner-qr-code').show();
                            $('#scanner-output').text("");
                            initializeQRScanner();
                        }, 4000);
                    });
            };

            if (!qrCodeScanner) {
                qrCodeScanner = new Html5QrcodeScanner("scanner-qr-code", { fps: 10, qrbox: 250, rememberLastUsedCamera: true });
                qrCodeScanner.render(qrCodeSuccessCallback, (error) => console.error("Error during QR code scanning:", error));
            }
        }

        async function sendDataToServer(data) {
            const url = 'https://mcq-x-cityhunter-gen2-bfdadb7ba57d.herokuapp.com/action/QRCode/CreateRecord';
            await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionStorage.getItem('accessToken')}`
                },
                body: JSON.stringify({
                    地點群組: locationGroup,
                    序號: data.decodedText,
                    經度: data.gps.latitude,
                    緯度: data.gps.longitude,
                    偏差: data.gps.accuracy,
                })
            });
        }

        function getGPSInfo() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: position.timestamp
                        }),
                        (error) => {
                            const errors = {
                                1: "User denied the request for Geolocation.",
                                2: "Location information is unavailable.",
                                3: "The request to get user location timed out.",
                                0: "An unknown error occurred."
                            };
                            reject(errors[error.code] || "Geolocation is not supported by this browser.");
                        }
                    );
                } else {
                    reject("Geolocation is not supported by this browser.");
                }
            });
        }

        // Global map variable
        let map;

        async function initMap() {
            isMapInitialized = true;

            // Initialize the map only once if not already initialized
            if (!map) {
                map = L.map('map').setView([22.3964, 114.1099], 11);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 24,
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            }

            const gps = await getGPSInfo();
            const queryParams = new URLSearchParams({
                地點群組: $('#location-group-2-input').val(),
                用戶經度: gps.latitude,
                用戶緯度: gps.longitude,
                偏差: 10
            });

            const geoinfo = await fetchGeoInfo(queryParams);
            updateMapMarkers(geoinfo);

            alert("地圖已更新！");
        }

        async function fetchGeoInfo(queryParams) {
            const response = await fetch(
                `https://mcq-x-cityhunter-gen2-bfdadb7ba57d.herokuapp.com/action/Map/GetGeoinfo?${queryParams}`,
                {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionStorage.getItem('accessToken')}`
                    },
                }
            );
            return await response.json();
        }

        function updateMapMarkers(geoinfo) {
            // Clear existing markers if the map was previously initialized
            if (map.markers) {
                map.markers.forEach(marker => marker.remove());
            }
            map.markers = []; // Initialize markers array

            // Define icons
            const questionIcon = L.icon({
                iconUrl: '圖庫/Question.png',
                iconSize: [41, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            });

            const userIcon = L.icon({
                iconUrl: '圖庫/User.png',
                iconSize: [41, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            });

            // Check if the geoinfo data is available
            if (geoinfo.success && geoinfo.data.geoinfo.length > 0) {
                geoinfo.data.geoinfo.forEach(location => {
                    const locationKey = Object.keys(location)[0];
                    const { lat, lng } = location[locationKey];

                    // Select the icon based on the key
                    const icon = locationKey.startsWith("QUESTION_") ? questionIcon : userIcon;

                    // Create a marker for each location using the appropriate icon
                    const marker = L.marker([lat, lng], { icon }).addTo(map)
                        .bindPopup(locationKey);

                    map.markers.push(marker); // Store the marker in the map object
                });
            } else {
                console.error("No geoinfo data available");
            }
        }
    </script>
</body>

<style>
    body {
        background: linear-gradient(to bottom, #d9e8f5, #f0f4ff);
        font-family: Arial, sans-serif;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        flex-direction: column;
    }

    .auth-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 400px;
    }

    .form-outline {
        position: relative;
        margin-bottom: 1.5rem;
    }

    input:focus+.form-label,
    input:not(:placeholder-shown)+.form-label {
        top: -10px;
        left: 10px;
        font-size: 12px;
        color: #007BFF;
    }

    #map {
        width: 100%;
        height: 400px;
    }
</style>

</html>