<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>「MCQ」x「城市獵人」（第二代）</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/css/bootstrap.min.css"
        integrity="sha512-2bBQCjcnw658Lho4nlXJcc6WkV/UxpE/sAokbXPxQNGqmNdQrWqtw26Ns9kFF/yG792pKR1Sx8/Y1Lf1XN4GKA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.8/js/bootstrap.min.js"
        integrity="sha512-nKXmKvJyiGQy343jatQlzDprflyB5c+tKCzGP3Uq67v+lmzfnZUi/ZT+fc6ITZfSC5HhaBKUIvr/nTLCV+7F+Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        body {
            background: linear-gradient(to bottom, #d9e8f5, #f0f4ff);
            font-family: Arial, sans-serif;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            flex-direction: column;
        }

        .auth-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }

        .form-outline {
            position: relative;
            margin-bottom: 1.5rem;
        }

        input:focus+.form-label,
        input:not(:placeholder-shown)+.form-label {
            top: -10px;
            left: 10px;
            font-size: 12px;
            color: #007BFF;
        }

        .tab-content {
            display: none;
        }

        .tab-pane {
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>

    <div class="auth-card" id="auth-card">
        <h2 class="text-center" id="form-title">Login</h2>
        <form id="auth-form" class="mt-4">
            <div class="form-outline">
                <input type="email" id="username" class="form-control" placeholder=" " required
                    value="admin@gmail.com" />
                <label class="form-label" for="username">Email address</label>
            </div>
            <div class="form-outline">
                <input type="password" id="password" class="form-control" placeholder=" " required value="Pass1234" />
                <label class="form-label" for="password">Password</label>
            </div>

            <div class="form-outline" id="confirmed-password-container" style="display: none;">
                <input type="password" id="password-confirm" class="form-control" placeholder=" " required
                    value="Pass1234" />
                <label class="form-label" for="password-confirm">Confirmed Password</label>
            </div>
            <button type="button" id="auth-btn" class="btn btn-primary btn-block mb-4">Login</button>
            <div class="text-center mb-3">
                <p><span id="membership">Not a member?</span> <a href="#!" id="toggle-btn">Register</a></p>
            </div>
            <p class="text-danger text-center" id="auth-message"></p>
        </form>
        <div id="dummy-form" class="d-flex justify-content-center align-items-center" style="visibility: hidden">
            <div>Loading...</div>
        </div>
    </div>

    <div id="tabs" class="container mt-4" style="display: none;">
        <ul class="nav nav-tabs">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab1">角色</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab2">問題</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab3">掃瞄</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab4">地圖</a></li>
        </ul>
        <div class="tab-content mt-2">
            <div id="tab1" class="tab-pane active">Content for 角色 tab.</div>
            <div id="tab2" class="tab-pane">Content for 問題 tab.</div>
            <div id="tab3" class="tab-pane" id="scan-content">
                <div>
                    <h4>Scan QR Code</h4>
                    <label id="label-地點群組"></label>
                    <select class="form-control" id="地點群組">
                        <option value="" hidden selected>--- 請選擇 ---</option>
                        <option value="__DEBUG__">__DEBUG__</option>
                    </select>
                    <div id="scanner-qr-code" style="width: 300px; height: 300px; display: none"></div>
                    <p id="scanner-result"></p>
                    <p id="scanner-output"></p>
                </div>
            </div>
            <div id="tab4" class="tab-pane">Content for 地圖 tab.</div>
        </div>
    </div>

    <script type="module" defer>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBHkSyXhIlblAgfVnu4D9y0edxXS3-0p50",
            authDomain: "mcq-x-cityhunter-gen2.firebaseapp.com",
            projectId: "mcq-x-cityhunter-gen2",
            storageBucket: "mcq-x-cityhunter-gen2.firebasestorage.app",
            messagingSenderId: "84375603912",
            appId: "1:84375603912:web:e795865e8236efedd973fd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        $(document).ready(function () {

            let isLogin = true;
            let isScanning = true;

            $('#toggle-btn').on('click', toggleForm);

            // Event listener for change in 地點群組
            $('#地點群組').on('change', function (e) {
                const selectedValue = $(this).val();
                document.querySelector('#label-地點群組').innerText = `地點群組: 「${document.querySelector('#地點群組').value}」`;
                if (selectedValue && selectedValue !== '') {
                    $('#scanner-qr-code').show(); // Show the QR Code scanner
                } else {
                    $('#scanner-qr-code').hide(); // Hide the QR Code scanner if no valid selection
                }
                $(e.target).hide();
            });
            function toggleForm() {
                isLogin = !isLogin;
                $('#form-title').text(isLogin ? 'Login' : 'Register');
                $('#auth-btn').text(isLogin ? 'Sign in' : 'Register');
                $('#toggle-btn').text(isLogin ? 'Register' : 'Login');
                $('#membership').text(isLogin ? 'Not a member?' : 'Already a member?');
                $('#auth-message').text('');

                if (isLogin) {
                    document.querySelector('#confirmed-password-container').style.display = 'none';
                } else {
                    document.querySelector('#confirmed-password-container').style.display = 'block';
                }

                $('#confirm-password-container').toggle(isLogin);
            }

            $('#auth-btn').on('click', async function () {
                $("#dummy-form").css('visibility', 'visible');
                $("#auth-form").css('visibility', 'hidden');

                const username = $('#username').val();
                const password = $('#password').val();
                const passwordConfirm = $('#password-confirm').val();

                if (isLogin) {
                    await authenticate(username, password);
                } else {
                    if (password === passwordConfirm) {
                        await register(username, password);
                    } else {
                        $('#auth-message').text('Passwords do not match.');
                    }
                }

                $("#dummy-form").css('visibility', 'hidden');
                $("#auth-form").css('visibility', 'visible');
            });

            async function register(email, password) {
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    $('#auth-message').text('Registration successful! Welcome, ' + userCredential.user.email);
                    setTimeout(() => {
                        toggleForm();
                    }, 200);
                } catch (error) {
                    $('#auth-message').text(error.message);
                }
            }

            async function authenticate(email, password) {
                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const accessToken = await user.getIdToken();
                    sessionStorage.setItem('accessToken', accessToken);
                    $('body').addClass('d-flex justify-content-start mt-4');
                    $('.tab-content').addClass('active');
                    $('#auth-message').text('Login successful! Welcome back, ' + user.email);
                    $('#auth-card').hide(); // Hide the login form
                    $('#tabs').show(); // Show the tabs
                    window.data = {
                        character: {},
                        question: {},
                        scanner: {},
                        map: {},
                    }

                    await initializeQRScanner();
                } catch (error) {
                    $('#auth-message').text(error.message);
                }
            }

            let qrCodeScanner; // Declare qrCodeScanner in a broader scope

            async function initializeQRScanner() {
                const qrCodeSuccessCallback = async (decodedText, decodedResult) => {
                    if (!isScanning) return;

                    isScanning = false;

                    document.querySelector("#scanner-qr-code").style.display = "none"; // Hide camera display
                    document.querySelector('#地點群組').style.display = 'none';
                    document.querySelector('#label-地點群組').style.display = 'block';

                    const gps = await getGPSInfo();
                    window.data.scanner = { decodedText, gps: gps };

                    document.querySelector("#scanner-output").innerText = `掃描結果: ${decodedText}\n經度: ${gps.longitude}\n緯度: ${gps.latitude}\n偏差: ${gps.accuracy} 公尺\n時間: ${new Date(gps.timestamp).toLocaleString()}`;
                    document.querySelector('#label-地點群組').innerText = `地點群組: 「${document.querySelector('#地點群組').value}」`;

                    const response = await fetch('https://mcq-x-cityhunter-gen2-bfdadb7ba57d.herokuapp.com/action/QRCode/CreateRecord', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionStorage.getItem('accessToken')}`
                        },
                        body: JSON.stringify({
                            地點群組: document.querySelector('#地點群組').value,
                            序號: decodedText,
                            經度: gps.latitude,
                            緯度: gps.longitude,
                            偏差: gps.accuracy
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Data sent successfully:', result);
                    } else {
                        const errorMessage = await response.text();
                        console.error('Error sending data:', errorMessage);
                    }

                    // Using setTimeout to re-enable scanning after a short delay
                    setTimeout(() => {
                        isScanning = true; // Reset the scanning flag
                        document.querySelector("#scanner-qr-code").style.display = "block"; // Show camera display again
                        document.querySelector("#scanner-output").innerText = "";
                        document.querySelector('#地點群組').style.display = 'block';
                        document.querySelector('#label-地點群組').style.display = 'none';
                        initializeQRScanner(); // Call this function to restart scanning
                    }, 4000); // 1 second delay for feedback
                };

                if (!qrCodeScanner) {
                    // Create an instance of Html5QrcodeScanner only if it doesn't exist
                    qrCodeScanner = new Html5QrcodeScanner(
                        "scanner-qr-code",
                        {
                            fps: 10,
                            qrbox: 250,
                            rememberLastUsedCamera: true
                        }
                    );

                    qrCodeScanner.render(
                        qrCodeSuccessCallback,
                        (error) => {
                            console.error("Error during QR code scanning:", error);
                        }
                    );
                }
            }

            function getGPSInfo() {
                return new Promise((resolve, reject) => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                // Resolve with the position object if successful
                                resolve({
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude,
                                    accuracy: position.coords.accuracy,
                                    timestamp: position.timestamp
                                });
                            },
                            (error) => {
                                // Reject with error message if there's an error
                                switch (error.code) {
                                    case error.PERMISSION_DENIED:
                                        reject("User denied the request for Geolocation.");
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        reject("Location information is unavailable.");
                                        break;
                                    case error.TIMEOUT:
                                        reject("The request to get user location timed out.");
                                        break;
                                    case error.UNKNOWN_ERROR:
                                        reject("An unknown error occurred.");
                                        break;
                                }
                            }
                        );
                    } else {
                        // Reject if geolocation is not supported
                        reject("Geolocation is not supported by this browser.");
                    }
                });
            }
        });
    </script>
</body>

</html>